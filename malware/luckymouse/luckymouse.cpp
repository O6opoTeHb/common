#include "luckymouse.h"

using namespace std;

void decrypt_lm_next_stage (const std::string& fn) {
    file lm_file(fn);
    int offset = 0xA66; // start of the encrypted part
    int rounds = 0x9A; // len of the encrypted part

    storage init_key = {0x0C, 0xC3, 0x42, 0x06}; // hardcoded initial key
    lm_file.map_file();
    storage_p t =  make_shared<storage>(lm_file.get_mapping()->begin()+offset, lm_file.get_mapping()->begin()+offset+rounds); // encrypted slice
    dexor_key_change(t, make_shared<storage>(init_key)); // decrypt slice
    lm_file.patch_mapping(t, offset); // patch mapping
    lm_file.dump_mapping_to_file(fn + ".dec");
    cout << "Decrypted file dumped to " << fn << ".dec" << endl;
}