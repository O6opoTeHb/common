#include "origamielephant.h"

using namespace std;

storage_p decrypt_origami_c2(storage_p enc, storage_p key) {
  size_t writen;
  unsigned char decoded[enc->size()];
  storage decrypted;
  storage_p decrypted_p = make_shared<storage>(decrypted);
  string decoded_str;

  //TODO try to get decoded len first, not truncate in append
  mbedtls_base64_decode(decoded, enc->size(), &writen,
						reinterpret_cast<const unsigned char *>(enc->data()), enc->size());
  decoded_str.append(reinterpret_cast<const char *>(decoded), writen);
  decrypted_p = build_storage(decoded_str);
  dexor(decrypted_p, key, key->size());
  return decrypted_p;
}